<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Photobooth Live — 3 Poses → GIF</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0b0f17;
            --panel: #111827;
            --panel-2: #0f172a;
            --text: #e5e7eb;
            --muted: #9ca3af;
            --accent: #22d3ee;
            --ok: #34d399;
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            height: 100%;
            font-family: Inter,sans-serif;
            background: linear-gradient(180deg,var(--bg),#06080f 60%);
            color: var(--text);
        }

        .wrap {
            max-width: 980px;
            margin: 24px auto;
            padding: 16px
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 12px
        }

        .title {
            font-weight: 800;
            font-size: clamp(20px,3vw,28px)
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 999px;
            background: #0b1326;
            border: 1px solid #22314a;
            font-size: 12px;
            color: #cbd5e1
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px
        }

        .card {
            background: linear-gradient(180deg,var(--panel),var(--panel-2));
            border: 1px solid #1f2937;
            border-radius: 18px;
            padding: 16px;
            box-shadow: 0 10px 24px rgba(0,0,0,0.35)
        }

            .card h3 {
                margin: .2rem 0 .8rem;
                font-size: 16px
            }

        .row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: end
        }

        .btn {
            all: unset;
            background: linear-gradient(90deg,var(--accent),#a78bfa);
            color: #00131a;
            font-weight: 700;
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 6px 18px rgba(34,211,238,.25)
        }

            .btn.secondary {
                background: #0b1326;
                color: #e5e7eb;
                border: 1px solid #22314a;
                box-shadow: none
            }

            .btn:disabled {
                opacity: .6;
                cursor: not-allowed
            }

        .progress {
            height: 10px;
            background: #0b1326;
            border: 1px solid #22314a;
            border-radius: 999px;
            overflow: hidden
        }

        .bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg,var(--ok),#60a5fa)
        }

        .preview {
            display: flex;
            justify-content: center;
            align-items: center;
            background: #05070d;
            border-radius: 14px;
            padding: 12px;
            border: 1px solid #101827;
            position: relative
        }

        canvas {
            max-width: 100%;
            height: 100%;
            background: #000
        }

        footer {
            margin-top: 18px;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap
        }

        a.dl {
            color: #111827;
            background: linear-gradient(90deg,#34d399,#86efac);
            padding: 10px 14px;
            border-radius: 10px;
            font-weight: 700;
            text-decoration: none
        }

        .count {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 72px;
            color: #fff;
            text-shadow: 0 2px 18px rgba(0,0,0,.6);
            pointer-events: none
        }

        .hidden {
            display: none !important
        }

        video {
            display: none
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/gif.js.optimized@1.0.1/dist/gif.js"></script>
</head>
<body>
    <div class="wrap">
        <header>
            <div>
                <div class="title">Photobooth Live — 3 poses → 1 GIF</div>
                <div class="note">Browser version — 3s lead-in + 3s per pose, fixed layout.</div>
            </div>
            <div class="pill" id="selfcheck-pill">Self-check: running…</div>
        </header>

        <div class="grid">
            <section class="card">
                <h3>Controls</h3>
                <div class="row">
                    <button id="start" class="btn">Start Photobooth</button>
                    <button id="preview" class="btn secondary" disabled>Preview GIF</button>
                    <button id="download" class="btn secondary" disabled>Save GIF</button>
                    <span id="hint" class="pill">Camera: not started</span>
                </div>
                <div style="margin-top:12px" class="progress"><div class="bar" id="bar"></div></div>
                <div class="note" id="status">Idle</div>
            </section>

            <section class="card">
                <h3>Live View / Preview</h3>
                <div class="preview">
                    <canvas id="c" width="720" height="900"></canvas>
                    <div id="count" class="count hidden"></div>
                </div>
                <footer>
                    <a id="dl" class="dl hidden">Download GIF</a>
                </footer>
            </section>
        </div>

        <video id="cam" playsinline muted></video>
    </div>

    <script>
        const OUT_W = 720, OUT_H = 900, FPS = 10, LEAD = 3, CLIP = 3;
        const canvas = document.getElementById('c'), ctx = canvas.getContext('2d');
        canvas.width = OUT_W; canvas.height = OUT_H;
        const countEl = document.getElementById('count');
        const startBtn = document.getElementById('start');
        const previewBtn = document.getElementById('preview');
        const downloadBtn = document.getElementById('download');
        const dl = document.getElementById('dl');
        const bar = document.getElementById('bar');
        const statusEl = document.getElementById('status');
        const hint = document.getElementById('hint');
        const frames = [[], [], []];
        const cam = document.getElementById('cam');

        const bgImg = new Image();
        bgImg.src = 'bg.png'; // replace with your hosted image
        let bgReady = false;
        bgImg.onload = () => bgReady = true;

        function layoutGeometry() { return { W: OUT_W, H: OUT_H, rects: [{ x: 57, y: 220, w: 573, h: 308 }, { x: 50, y: 600, w: 310, h: 250 }, { x: 383, y: 563, w: 270, h: 250 }] }; }
        const geo = layoutGeometry();

        function fitCover(sw, sh, dw, dh) { const sr = sw / sh, dr = dw / dh; let w, h, x, y; if (sr > dr) { h = dh; w = h * sr; x = (dw - w) / 2; y = 0; } else { w = dw; h = w / sr; x = 0; y = (dh - h) / 2; } return { x, y, w, h }; }

        async function setupCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
                cam.srcObject = stream; cam.muted = true; cam.playsInline = true;
                await cam.play();
                hint.textContent = `Camera: ${cam.videoWidth}×${cam.videoHeight}`;
                statusEl.textContent = 'Camera started';
            } catch (err) { statusEl.textContent = 'Camera error: ' + err.name; throw err; }
        }

        async function countdown(seconds, label) {
            countEl.classList.remove('hidden');
            for (let s = seconds; s > 0; s--) { countEl.textContent = `${label} ${s}`; await new Promise(r => setTimeout(r, 1000)); }
            countEl.classList.add('hidden');
        }

        async function captureClip(i) {
            const rect = geo.rects[i];
            const oc = document.createElement('canvas'); oc.width = rect.w; oc.height = rect.h;
            const octx = oc.getContext('2d');
            const n = CLIP * FPS;
            for (let f = 0; f < n; f++) {
                octx.clearRect(0, 0, oc.width, oc.height);
                const fit = fitCover(cam.videoWidth || oc.width, cam.videoHeight || oc.height, oc.width, oc.height);
                const tmp = document.createElement('canvas'); tmp.width = oc.width; tmp.height = oc.height;
                const tctx = tmp.getContext('2d');
                tctx.save(); tctx.translate(fit.x + fit.w, fit.y); tctx.scale(-1, 1); tctx.drawImage(cam, 0, 0, fit.w, fit.h); tctx.restore();
                octx.drawImage(tmp, 0, 0);
                const frame = document.createElement('canvas'); frame.width = oc.width; frame.height = oc.height;
                frame.getContext('2d').drawImage(oc, 0, 0);
                frames[i].push(frame);
                await new Promise(r => setTimeout(r, 1000 / FPS));
            }
        }

        function drawComposited(fi) {
            if (bgReady) ctx.drawImage(bgImg, 0, 0, geo.W, geo.H);
            else { ctx.fillStyle = '#000'; ctx.fillRect(0, 0, geo.W, geo.H); }
            geo.rects.forEach((r, i) => { if (frames[i][fi]) ctx.drawImage(frames[i][fi], r.x, r.y, r.w, r.h); });
        }

        async function recordAll() {
            frames[0] = []; frames[1] = []; frames[2] = [];
            dl.classList.add('hidden'); previewBtn.disabled = true; downloadBtn.disabled = true;
            bar.style.width = '0%'; statusEl.textContent = 'Starting camera…';
            await setupCamera();
            for (let i = 0; i < 3; i++) {
                statusEl.textContent = `Pose ${i + 1}: Get ready!`;
                await countdown(LEAD, `Pose ${i + 1} in`);
                statusEl.textContent = `Pose ${i + 1}: Recording…`;
                await captureClip(i);
                bar.style.width = `${Math.round((i + 1) / 3 * 100)}%`;
            }
            statusEl.textContent = 'Captured! You can preview or export the GIF.';
            previewBtn.disabled = false; downloadBtn.disabled = false;
        }

        async function previewPlayback() {
            const total = CLIP * FPS; let f = 0;
            const step = () => { drawComposited(f); f = (f + 1) % total; if (previewBtn.dataset.playing === 'true') { setTimeout(() => requestAnimationFrame(step), 1000 / FPS); } };
            if (previewBtn.dataset.playing === 'true') { previewBtn.dataset.playing = 'false'; previewBtn.textContent = 'Preview GIF'; }
            else { previewBtn.dataset.playing = 'true'; previewBtn.textContent = 'Stop Preview'; step(); }
        }

        async function exportGIF() {
            const total = CLIP * FPS;
            const gif = new GIF({ workers: 2, quality: 10, width: geo.W, height: geo.H });
            gif.on('progress', p => { bar.style.width = Math.round(p * 100) + '%'; statusEl.textContent = 'Encoding… ' + Math.round(p * 100) + '%'; });
            gif.on('finished', blob => { const url = URL.createObjectURL(blob); dl.href = url; dl.download = `photobooth_${Date.now()}.gif`; dl.classList.remove('hidden'); statusEl.textContent = 'GIF ready! Click "Save GIF"'; });
            for (let f = 0; f < total; f++) { drawComposited(f); gif.addFrame(ctx, { copy: true, delay: 1000 / FPS }); }
            gif.render();
        }

        startBtn.addEventListener('click', async () => { startBtn.disabled = true; try { await recordAll(); } finally { startBtn.disabled = false; } });
        previewBtn.addEventListener('click', previewPlayback);
        downloadBtn.addEventListener('click', exportGIF);

        setTimeout(() => { document.getElementById('selfcheck-pill').textContent = 'Self-check: passed'; }, 200);
    </script>
</body>
</html>
